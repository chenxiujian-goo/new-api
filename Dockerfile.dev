# 阶段1：构建前端
FROM node:18-alpine AS web-builder
WORKDIR /app/web
COPY web/package*.json ./
RUN npm install --legacy-peer-deps --prefer-offline
COPY web/ ./
RUN npm run build  # 如果有构建步骤

# 阶段2：构建Go后端
FROM golang:1.23.4-alpine AS go-builder
WORKDIR /app
COPY go.mod go.sum ./
RUN go mod download
COPY . .
COPY --from=web-builder /app/web/dist ./web/dist
RUN go build -o main .

# 阶段3：最终开发镜像（包含运行时和工具）
FROM golang:1.23.4-alpine
WORKDIR /app

# 安装Node.js（用于前端开发）
RUN apk add --no-cache nodejs npm

# 复制后端二进制
COPY --from=go-builder /app/main .

# 复制前端代码（或构建产物）
COPY --from=web-builder /app/web ./web

# 安装兼容 Go 1.23 的 air 热重载工具
RUN go install github.com/air-verse/air@v1.61.5

# 暴露端口（根据实际需求调整）
EXPOSE 3000

# 默认启动命令（可覆盖）
CMD ["air", "-c", ".air.toml"]
